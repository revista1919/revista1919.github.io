name: Notificaci√≥n de nuevas postulaciones

on:
  schedule:
    - cron: "*/10 * * * *" # corre cada 10 minutos
  workflow_dispatch: # tambi√©n puedes lanzarlo manualmente

jobs:
  check-and-send:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Descargar CSV de Google Sheets
      run: curl -s "https://docs.google.com/spreadsheets/d/e/2PACX-1vSNuBETm7TapO6dakKBbkxlYTZctAGGEp4SnOyGowCYXfD_lAXHta8_LX5EPjy0xXw5fpKp3MPcRduK/pub?gid=2123840957&single=true&output=csv" -o sheet.csv

    - name: Comparar con CSV anterior
      id: diff
      run: |
        mkdir -p data
        if [ -f data/last.csv ]; then
          diff=$(comm -13 <(sort data/last.csv) <(sort sheet.csv))
          echo "$diff" > data/diff.txt
        else
          cp sheet.csv data/last.csv
          echo "" > data/diff.txt
        fi
        echo "diff<<EOF" >> $GITHUB_OUTPUT
        cat data/diff.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Formatear HTML con nuevas postulaciones
      if: steps.diff.outputs.diff != ''
      id: format
      run: |
        echo "<h2>üìã Nuevas postulaciones recibidas</h2>" > email.html
        echo "<p>Se han detectado nuevas postulaciones en el formulario. Aqu√≠ est√°n los detalles:</p>" >> email.html
        echo "<hr/>" >> email.html

        while IFS=',' read -r marca cargo nombre correo colegio telefono carta
        do
          echo "<div style='margin-bottom:20px; padding:10px; border:1px solid #ddd; border-radius:8px;'>" >> email.html
          echo "<b>‚è∞ Marca temporal:</b> $marca <br/>" >> email.html
          echo "<b>üìå Cargo:</b> $cargo <br/>" >> email.html
          echo "<b>üë§ Nombre:</b> $nombre <br/>" >> email.html
          echo "<b>üìß Correo:</b> $correo <br/>" >> email.html
          echo "<b>üè´ Establecimiento:</b> $colegio <br/>" >> email.html
          echo "<b>üì± Tel√©fono:</b> $telefono <br/>" >> email.html
          echo "<b>üìù Carta de motivaci√≥n:</b><br/> <blockquote>$carta</blockquote>" >> email.html
          echo "</div><hr/>" >> email.html
        done < data/diff.txt

        echo "body<<EOF" >> $GITHUB_OUTPUT
        cat email.html >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Enviar correo con nuevas postulaciones
      if: steps.diff.outputs.diff != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.GMAIL_USER }}
        password: ${{ secrets.GMAIL_PASS }}
        subject: "üì¨ Nuevas postulaciones recibidas"
        to: "revistaestudiantespentauc@gmail.com"
        from: "Comit√© de Postulaciones <${{ secrets.GMAIL_USER }}>"
        content_type: text/html
        body: ${{ steps.format.outputs.body }}

    - name: Guardar CSV actual
      run: cp sheet.csv data/last.csv
